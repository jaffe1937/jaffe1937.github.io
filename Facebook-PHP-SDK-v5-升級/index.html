<!DOCTYPE html>
<html lang="zh-CN">

<!-- Head tag -->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <!--Description-->
  
  <meta name="description" content="記錄程式設計或其他跟技術相關的學習心得...">
  

  <!--Author-->
  
  <meta name="author" content="Jaffe Tseng">
  

  <!--Open Graph Title-->
  
      <meta property="og:title" content="Facebook PHP SDK v5 升級"/>
  
  <!--Open Graph Description-->
  
      <meta property="og:description" content="記錄程式設計或其他跟技術相關的學習心得..." />
  
  <!--Open Graph Site Name-->
  <meta property="og:site_name" content="im&#39;Jaffe"/>
  <!--Type page-->
  
      <meta property="og:type" content="article" />
  
  <!--Page Cover-->
  

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <!-- Title -->
  
  <title>Facebook PHP SDK v5 升級 - im&#39;Jaffe</title>


  <link rel="shortcut icon" href="https://github.com/jaffe1937/jaffe1937.github.io/blob/master/faviconj.png">

  <!-- Custom CSS/Sass -->
  <link rel="stylesheet" href="/css/style.css">

  <!----------------------------
  https://github.com/GallenHu/hexo-theme-Daily

 _____            _   _
|  __ \          (_) | |
| |  | |   __ _   _  | |  _   _
| |  | |  / _` | | | | | | | | |
| |__| | | (_| | | | | | | |_| |
|_____/   \__,_| |_| |_|  \__, |
                          __/ |
                         |___/

    --------------------------->

</head>


<body>

  <!-- Nav -->
  <header class="site-header">
  <div class="header-inside">
    <div class="logo">
      <a href="/" rel="home">
        
        <img src="https://hexo.io/logo.svg" alt="im'Jaffe" height="60">
        
      </a>
    </div>
    <!-- Navigation -->
    <nav class="navbar">
      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse">
        <ul class="navbar-nav">
          
          
            <li>
              <a href="/.">
                
                  home
                
              </a>
            </li>
          
            <li>
              <a href="/archives">
                
                  archive
                
              </a>
            </li>
          
        </ul>
      </div>
      <!-- /.navbar-collapse -->
    </nav>
    <div class="button-wrap">
      <button class="menu-toggle">Primary Menu</button>
    </div>
  </div>
</header>


  <!-- Main Content -->
  <div class="content-area">
  <div class="post">
    <!-- Post Content -->
    <div class="container">
      <article>
        <!-- Title date & tags -->
        <div class="post-header">
          <h1 class="entry-title">
            Facebook PHP SDK v5 升級
            
          </h1>
          <p class="posted-on">
          05-24-2017
          </p>
          <div class="tags-links">
            
              
                <a href="/tags/FacebookSDK, PHP, hexo/" rel="tag">
                  FacebookSDK, PHP, hexo
                </a>
              
            
          </div>
        </div>
        <!-- Post Main Content -->
        <div class="entry-content">
          <h2 id="Facebook-PHP-SDK-v5-升級"><a href="#Facebook-PHP-SDK-v5-升級" class="headerlink" title="Facebook PHP SDK v5 升級"></a>Facebook PHP SDK v5 升級</h2><p>到新公司報到第一天，公司就告知最近網站FB login無法使用，希望我可以盡快確認為何無法使用；連上服務器把相關的檔案都下載回來，打開一看SDK v4、API v2.2，上網查了些資料，才知道API v2.2已經使用過期了，不能再使用這個版本，雖然FB會自動升級API版本，但因為SDK的版本也是舊的，新版的API以SDK v5進行開發，看到這也只好乖乖的把SDK跟API都升級。</p>
<p><a href="https://developers.facebook.com/docs/apps/changelog" target="_blank" rel="external">Facebook 開放平台變更紀錄</a></p>
<h3 id="升級準備"><a href="#升級準備" class="headerlink" title="升級準備"></a>升級準備</h3><p><img src="http://i.imgur.com/5Qf9rtc.png" alt="FB Login"></p>
<p>設定FB AppID，在SDK v5的版本中，API預設會使用目前最低的版本，建議使用<code>&#39;default_graph_version&#39; =&gt; &#39;v2.8&#39;</code>自行設定最新的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">v4.0：</div><div class="line"></div><div class="line">session_start();</div><div class="line"> </div><div class="line">// Facebook app settings</div><div class="line">$app_id       = &apos;&apos;;</div><div class="line">$app_secret   = &apos;&apos;;</div><div class="line">$redirect_uri = &apos;&apos;;</div><div class="line"> </div><div class="line">// Requested permissions for the app - optional.</div><div class="line">$permissions = array(</div><div class="line">    &apos;email&apos;,</div><div class="line">    &apos;user_location&apos;,</div><div class="line">    &apos;user_birthday&apos;</div><div class="line">);</div><div class="line"> </div><div class="line">// Define the root directoy.</div><div class="line">define( &apos;ROOT&apos;, dirname( __FILE__ ) . &apos;/&apos; );</div><div class="line"> </div><div class="line">// Autoload the required files</div><div class="line">require_once( ROOT . &apos;vendor/autoload.php&apos; );</div><div class="line"> </div><div class="line">use Facebook\FacebookSession;</div><div class="line">use Facebook\FacebookRequest;</div><div class="line">use Facebook\FacebookRedirectLoginHelper;</div><div class="line">use Facebook\GraphUser;</div><div class="line"> </div><div class="line">// Initialize the SDK.</div><div class="line">FacebookSession::setDefaultApplication( $app_id, $app_secret );</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">v5.0：</div><div class="line"></div><div class="line">session_start();</div><div class="line"> </div><div class="line">// Include the required Composer dependencies.</div><div class="line">require_once( &apos;vendor/autoload.php&apos; );</div><div class="line"> </div><div class="line">// Initialize the Facebook PHP SDK v5.</div><div class="line">$fb = new Facebook\Facebook([</div><div class="line">  &apos;app_id&apos;                =&gt; &apos;&#123;app-id&#125;&apos;,</div><div class="line">  &apos;app_secret&apos;            =&gt; &apos;&#123;app-secret&#125;&apos;,</div><div class="line">  &apos;default_graph_version&apos; =&gt; &apos;v2.3&apos;,</div><div class="line">]);</div></pre></td></tr></table></figure>
<p>取得登入網址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">v4.0：</div><div class="line"></div><div class="line">// Initialize the Facebook SDK.</div><div class="line">FacebookSession::setDefaultApplication( $app_id, $app_secret );</div><div class="line">$helper = new FacebookRedirectLoginHelper( $redirect_uri );</div><div class="line"></div><div class="line"></div><div class="line">v5.0：</div><div class="line"></div><div class="line">// Check if the user is logged in.</div><div class="line">$helper = $fb-&gt;getRedirectLoginHelper();</div></pre></td></tr></table></figure>
<p>登入完成取得 access_token：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line">v4.0：</div><div class="line"></div><div class="line">// Authorize the user.</div><div class="line">try &#123;</div><div class="line">    if ( isset( $_SESSION[&apos;access_token&apos;] ) ) &#123;</div><div class="line">        // Check if an access token has already been set.</div><div class="line">        $session = new FacebookSession( $_SESSION[&apos;access_token&apos;] );</div><div class="line">    &#125; else &#123;</div><div class="line">        // Get access token from the code parameter in the URL.</div><div class="line">        $session = $helper-&gt;getSessionFromRedirect();</div><div class="line">    &#125;</div><div class="line">&#125; catch( FacebookRequestException $ex ) &#123;</div><div class="line"> </div><div class="line">    // When Facebook returns an error.</div><div class="line">    print_r( $ex );</div><div class="line">&#125; catch( \Exception $ex ) &#123;</div><div class="line"> </div><div class="line">    // When validation fails or other local issues.</div><div class="line">    print_r( $ex );</div><div class="line">&#125;</div><div class="line">if ( isset( $session ) ) &#123;</div><div class="line"> </div><div class="line">    // Retrieve &amp; store the access token in a session.</div><div class="line">    $_SESSION[&apos;access_token&apos;] = $session-&gt;getToken();</div><div class="line"> </div><div class="line">    $logoutURL = $helper-&gt;getLogoutUrl( $session, &apos;http://your-app-domain.com/logout&apos; );</div><div class="line"> </div><div class="line">    // Logged in</div><div class="line">    echo &apos;Successfully logged in! &lt;a href=&quot;&apos; . $logoutURL . &apos;&quot;&gt;Logout&lt;/a&gt;&apos;;</div><div class="line">&#125; else &#123;</div><div class="line"> </div><div class="line">    // Generate the login URL for Facebook authentication.</div><div class="line">    $loginUrl = $helper-&gt;getLoginUrl();</div><div class="line">    echo &apos;&lt;a href=&quot;&apos; . $loginUrl . &apos;&quot;&gt;Login&lt;/a&gt;&apos;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">v.5.0：</div><div class="line"></div><div class="line">try &#123;</div><div class="line">  $accessToken = $helper-&gt;getAccessToken();</div><div class="line">&#125; catch( Facebook\Exceptions\FacebookSDKException $e ) &#123;</div><div class="line"> </div><div class="line">  // There was an error communicating with Graph</div><div class="line">  echo $e-&gt;getMessage();</div><div class="line">  exit;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">if ( isset( $accessToken ) ) &#123;</div><div class="line"> </div><div class="line">  // User authenticated your app!</div><div class="line">  // Save the access token to a session and redirect</div><div class="line">  $_SESSION[&apos;facebook_access_token&apos;] = ( string ) $accessToken;</div><div class="line"> </div><div class="line">  // Register or log the user in...</div><div class="line">  exit;</div><div class="line">&#125;</div><div class="line">elseif ( $helper-&gt;getError() ) &#123;</div><div class="line"> </div><div class="line">  // The user denied the request</div><div class="line">  // You could log this data . . .</div><div class="line">  var_dump( $helper-&gt;getError() );</div><div class="line">  var_dump( $helper-&gt;getErrorCode() );</div><div class="line">  var_dump( $helper-&gt;getErrorReason() );</div><div class="line">  var_dump( $helper-&gt;getErrorDescription() );</div><div class="line"> </div><div class="line">  // You could display a message to the user</div><div class="line">  // being all like, &quot;What? You don&apos;t like me?&quot;</div><div class="line">  exit;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">// If they&apos;ve gotten this far, they shouldn&apos;t be here</div><div class="line">http_response_code(400);</div><div class="line">exit;</div></pre></td></tr></table></figure>
<h3 id="修改心得"><a href="#修改心得" class="headerlink" title="修改心得"></a>修改心得</h3><p>這次修改API直接使用v2.8版本，再次碰到類似問題，應該是兩年後的事了，下次修改或許會把SDK再升級一次吧，至少修改完畢沒碰到什麼太大的問題；唯一問題是修改好，還沒保存下來，我的mac竟然出問題只能送修，默默的把問題重新再邊做邊找印象中的資料，來把問題修復，這告訴我之後要做好備份的習慣。</p>
<h4 id="參考下列文章："><a href="#參考下列文章：" class="headerlink" title="參考下列文章："></a>參考下列文章：</h4><p><a href="http://noumenon-th.net/programming/2016/03/14/facebook-sdk-for-php-v5-0/" target="_blank" rel="external">[Facebook SDK for PHP v5.0]を利用してログイン認証をおこなう[Oauth]</a><br><a href="http://blog.changyy.org/2017/03/php-facebook-graph-api-v22-codeigniter.html" target="_blank" rel="external">[PHP] Facebook Graph API v2.2 升級提醒 - CodeIgniter 2.x 與 Facebook PHP SDK v5</a><br><a href="https://www.codexworld.com/login-with-facebook-using-php/" target="_blank" rel="external">Login with Facebook using PHP</a></p>

        </div>
      </article>
    </div>
    <!-- Comments -->
    <div class="container">
      
<section id="comment">
  <!-- <h1 class="title">Comments</h1> -->

  
  <div id="disqus_thread">
    <script type="text/javascript">
    var disqus_config = function () {
          this.page.url = window.location.href;
          this.page.identifier = 'post-Facebook-PHP-SDK-v5-升級';
          this.page.title = 'Facebook PHP SDK v5 升級';
      };
    </script>
    <noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  </div>
  
</section>


    </div>
    <!-- Pre or Next -->
    <div class="nav-links">
      
      
        <div class="nav-next">
          <a href="/Hexo安裝心得/" rel="prev">Newer Posts <span class="meta-arraw meta-arraw-right"></span></a>
        </div>
      
    </div>

  </div>
</div>


  <!-- Footer -->
  <!-- Footer-widgets -->

    <script type="text/javascript">
    var disqus_shortname = 'jaffe1937-blog';
    var disqus_config = function () {
        this.page.url = 'http://jaffe1937.github.io/Facebook-PHP-SDK-v5-升級/';
        this.page.identifier = '/Facebook-PHP-SDK-v5-升級/';
        this.page.title = 'Facebook PHP SDK v5 升級';
    };
    (function(){
      var d = document;
      var dsq = d.createElement('script');
      dsq.type = 'text/javascript';
      dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
      (d.head || d.body).appendChild(dsq);
    })();
    </script>

<div class="footer-widgets">
  <div class="row inside-wrapper">
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">關於本站</h1>
        <div class="custom-widget-content">
          
          記錄程式設計或其他跟技術相關的學習心得...
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Contact</h1>
        <div class="widget-text">
          
            
              <a href="https://github.com/jaffe1937" class="icon icon-github" target="_blank">github</a>
            
          
        </div>
      </aside>
    </div>
    <div class="col-1-3">
      <aside>
        <h1 class="widget-title">Search</h1>
        <div class="widget-text">
          <form onSubmit="return appDaily.submitSearch('')">
            <p>
              <input type="text" placeholder="search..." id="homeSearchInput">
            </p>
            <!-- <input type="submit" value="GO"> -->
          </form>
        </div>
      </aside>
    </div>
  </div>
</div>
<!-- Footer -->
<footer class="site-info">
  <p>
    <span>im'Jaffe &copy; 2017</span>
    
      <span class="split">|</span>
      <span>Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> with Theme <a href="https://github.com/GallenHu/hexo-theme-Daily" target="_blank">Daily</a></span>
    
  </p>
</footer>


  <!-- After footer scripts -->
  <!-- scripts -->
<script src="/js/app.js"></script>

<script>
  var disqus_shortname = 'jaffe1937-blog';

  
  var disqus_url = 'http://jaffe1937.github.io/Facebook-PHP-SDK-v5-升級/';
  

  (function(){
    var dsq = document.createElement('script');
    dsq.type = 'text/javascript';
    dsq.async = true;
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>





</body>

</html>